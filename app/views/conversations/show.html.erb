<div class="messages_container">
  <ul class="messages-all">
  <% @messages.each do |m| %>

    <%= render 'messages/show', m: m %>

  <% end %>
  </ul>
</div>
<%= render 'messages/form', message: @message %>

<% content_for :after_js do %>
  <script>

    const scrollLastMessageIntoView = () => {
      const messages = document.querySelectorAll('.message');
      const lastMessage = messages[messages.length - 1];

      if (lastMessage !== undefined) {
        lastMessage.scrollIntoView();
      }
    }

    scrollLastMessageIntoView();
    App["conversation_<%= @conversation.id %>"] = App.cable.subscriptions.create(
      { channel: 'MessagesChannel', conversation_id: <%= @conversation.id %> },
      { received: (data) => {
        if (data.current_sender.length !== <%= current_user.role.size %>) {
          var messages = document.querySelector('.messages-all');
          messages.insertAdjacentHTML('beforeend', data.message_partial);
          scrollLastMessageIntoView();
        }
      }
    })
  </script>
<% end %>
